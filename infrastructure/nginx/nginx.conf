# ===================================================================
# NGINX - Main Configuration
# ===================================================================
#
# API Gateway for Titan Watch microservices
#
# Features:
# - Reverse proxy to all microservices
# - Load balancing
# - Rate limiting
# - CORS handling
# - SSL/TLS termination
# - Request/response logging
# - Health checks
#
# ===================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ===================================================================
    # LOGGING
    # ===================================================================

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'rt=$request_time uct="$upstream_connect_time" '
                       'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log detailed;

    # ===================================================================
    # PERFORMANCE
    # ===================================================================

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Buffers
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;
    output_buffers 1 32k;
    postpone_output 1460;

    # Timeouts
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    # ===================================================================
    # COMPRESSION
    # ===================================================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # ===================================================================
    # RATE LIMITING
    # ===================================================================

    # Define rate limit zones
    limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=20r/m;
    limit_req_zone $binary_remote_addr zone=api:10m rate=300r/m;

    # Connection limits
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    # ===================================================================
    # UPSTREAM SERVERS
    # ===================================================================

    # Auth Service
    upstream auth_service {
        least_conn;
        server auth-service:8001 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Jaeger Service
    upstream jaeger_service {
        least_conn;
        server jaeger-service:8002 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Shatterdome Service
    upstream shatterdome_service {
        least_conn;
        server shatterdome-service:8003 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Kaiju Service
    upstream kaiju_service {
        least_conn;
        server kaiju-service:8004 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Tracking Service - Write
    upstream tracking_write_service {
        least_conn;
        server tracking-service:8005 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Tracking Service - Read
    upstream tracking_read_service {
        least_conn;
        server tracking-service:8006 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Event Service
    upstream event_service {
        least_conn;
        server event-service:8007 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Maintenance Service
    upstream maintenance_service {
        least_conn;
        server maintenance-service:8008 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Analytics Service
    upstream analytics_service {
        least_conn;
        server analytics-service:8009 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Monitoring
    upstream prometheus {
        server prometheus:9090;
    }

    upstream grafana {
        server grafana:3000;
    }

    # ===================================================================
    # SECURITY HEADERS
    # ===================================================================

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # ===================================================================
    # INCLUDE VIRTUAL HOSTS
    # ===================================================================

    include /etc/nginx/conf.d/*.conf;
}
