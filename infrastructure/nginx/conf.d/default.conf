# ===================================================================
# NGINX - API Gateway Routes
# ===================================================================
#
# This file defines all routes for the Titan Watch API Gateway
#
# Route Structure:
# - /api/auth/*          -> Auth Service
# - /api/jaegers/*       -> Jaeger Service
# - /api/kaijus/*        -> Kaiju Service
# - /api/tracking/*      -> Tracking Service (CQRS)
# - /api/events/*        -> Event Service
# - /api/maintenance/*   -> Maintenance Service
# - /api/analytics/*     -> Analytics Service
# - /graphql             -> Shatterdome Service (GraphQL)
# - /metrics             -> Prometheus
# - /monitoring/*        -> Grafana
#
# ===================================================================

# ===================================================================
# MAIN SERVER BLOCK (HTTP)
# ===================================================================

server {
    listen 80;
    server_name localhost;

    # ===================================================================
    # HEALTH CHECK
    # ===================================================================

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    location /nginx-health {
        access_log off;
        stub_status;
    }

    # ===================================================================
    # CORS HEADERS
    # ===================================================================

    # Add CORS headers for all API routes
    add_header 'Access-Control-Allow-Origin' '$http_origin' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since' always;
    add_header 'Access-Control-Max-Age' 1728000 always;

    # ===================================================================
    # OPTIONS METHOD (CORS Preflight)
    # ===================================================================

    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # ===================================================================
    # AUTH SERVICE
    # ===================================================================

    location /api/auth {
        limit_req zone=auth burst=10 nodelay;
        limit_conn addr 10;

        rewrite ^/api/auth/(.*) /$1 break;

        proxy_pass http://auth_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Don't buffer for real-time responses
        proxy_buffering off;
    }

    # ===================================================================
    # JAEGER SERVICE
    # ===================================================================

    location /api/jaegers {
        limit_req zone=api burst=20 nodelay;
        limit_conn addr 20;

        rewrite ^/api/jaegers/(.*) /$1 break;

        proxy_pass http://jaeger_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================================================
    # SHATTERDOME SERVICE (GraphQL)
    # ===================================================================

    location /graphql {
        limit_req zone=api burst=30 nodelay;
        limit_conn addr 20;

        proxy_pass http://shatterdome_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # GraphQL Playground
    location /playground {
        proxy_pass http://shatterdome_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===================================================================
    # KAIJU SERVICE
    # ===================================================================

    location /api/kaijus {
        limit_req zone=api burst=30 nodelay;
        limit_conn addr 20;

        rewrite ^/api/kaijus/(.*) /$1 break;

        proxy_pass http://kaiju_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================================================
    # TRACKING SERVICE (CQRS)
    # ===================================================================

    # Write endpoints (POST)
    location ~ ^/api/tracking/(positions|batch) {
        limit_req zone=api burst=100 nodelay;
        limit_conn addr 50;

        rewrite ^/api/tracking/(.*) /$1 break;

        proxy_pass http://tracking_write_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Optimized for high-throughput writes
        proxy_connect_timeout 2s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        proxy_buffering off;
    }

    # Read endpoints (GET)
    location /api/tracking {
        limit_req zone=api burst=50 nodelay;
        limit_conn addr 30;

        rewrite ^/api/tracking/(.*) /$1 break;

        proxy_pass http://tracking_read_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Enable caching for read queries
        proxy_cache_valid 200 1m;
        proxy_cache_bypass $http_cache_control;

        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ===================================================================
    # EVENT SERVICE
    # ===================================================================

    location /api/events {
        limit_req zone=api burst=40 nodelay;
        limit_conn addr 20;

        rewrite ^/api/events/(.*) /$1 break;

        proxy_pass http://event_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================================================
    # MAINTENANCE SERVICE
    # ===================================================================

    location /api/maintenance {
        limit_req zone=api burst=20 nodelay;
        limit_conn addr 15;

        rewrite ^/api/maintenance/(.*) /$1 break;

        proxy_pass http://maintenance_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Longer timeout for saga workflows
        proxy_connect_timeout 5s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ===================================================================
    # ANALYTICS SERVICE
    # ===================================================================

    location /api/analytics {
        limit_req zone=api burst=30 nodelay;
        limit_conn addr 20;

        rewrite ^/api/analytics/(.*) /$1 break;

        proxy_pass http://analytics_service;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Longer timeout for analytics queries
        proxy_connect_timeout 5s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ===================================================================
    # MONITORING - PROMETHEUS
    # ===================================================================

    location /metrics {
        limit_req zone=general burst=5 nodelay;

        proxy_pass http://prometheus;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===================================================================
    # MONITORING - GRAFANA
    # ===================================================================

    location /monitoring/ {
        rewrite ^/monitoring/(.*) /$1 break;

        proxy_pass http://grafana;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for live updates
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ===================================================================
    # DEFAULT / ROOT
    # ===================================================================

    location / {
        return 200 '{"service":"Titan Watch API Gateway","version":"1.0.0","status":"operational"}';
        add_header Content-Type application/json;
    }

    # ===================================================================
    # ERROR PAGES
    # ===================================================================

    error_page 404 /404.json;
    location = /404.json {
        return 404 '{"error":"Not Found","message":"The requested resource was not found"}';
        add_header Content-Type application/json;
    }

    error_page 500 502 503 504 /50x.json;
    location = /50x.json {
        return 500 '{"error":"Internal Server Error","message":"Something went wrong"}';
        add_header Content-Type application/json;
    }
}
